#!/bin/bash
set -eo pipefail

if [ "$1" == "--help" ] || [ "$2" == "--help" ] || [ "$3" == "--help" ]; then
    fam --help
else
    which vivado > /dev/null || { echo "vivado not found in PATH"; exit 1; }
    which fam > /dev/null || { echo "fam not found in PATH"; exit 1; }

    echo "SRCS=\$(wildcard *.v)" > Makefile
    echo "FAMILY=xcup" >> Makefile
    echo "# flatten design before synthesis, no clock buffers, no IO buffers, no carry logic, no MUXes" >> Makefile
    echo "SYNTH_OPT=-flatten -noclkbuf -noiopad -nocarry -nowidelut -ise" >> Makefile
    echo "VIVADO=vivado #2019.2" >> Makefile
    echo "" >> Makefile
    echo ".PHONY: all clean" >> Makefile
    echo "" >> Makefile
    echo "all: mux_4_1_synth.v" >> Makefile
    echo "" >> Makefile
    echo "clean:" >> Makefile
    echo "	rm -f *.xil *.synth *.ys *.dot *.png *.tcl" >> Makefile
    echo "" >> Makefile
    echo "%.v.xil: %_xil.tcl" >> Makefile
    echo "	+\$(VIVADO) -mode tcl -source \$< -nolog -nojournal" >> Makefile
    echo "	rm \$<" >> Makefile
    echo "" >> Makefile
    echo "%_xil.tcl: %.v" >> Makefile
    echo "	@echo \"add_files \$<\" >> \$@" >> Makefile
    echo "	@filename=\$(basename \$(notdir \$<)); echo \"synth_design -top \$\$filename -mode out_of_context -part xc7z020clg484-1\" >> \$@" >> Makefile
    echo "	@echo \"write_verilog -force \$<.xil\" >> \$@" >> Makefile
    echo "	@echo \"quit\" >> \$@" >> Makefile
    echo "" >> Makefile

    make $1.xil
    fam $1.xil $2 $3 $4 $5 $6 $7 $8 $9 ${10} ${11} ${12} ${13} ${14} ${15} ${16}
    rm -f $1.xil
fi
